<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>产线异常提报</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
  <meta name="theme-color" content="#007bff" />
  <!-- PWA 图标 -->
  <link rel="icon" sizes="48x48" href="icons/48.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="icons/192.png" />
</head>
<body>
  <!-- 页面容器 -->
  <div id="app">
    <!-- 首页 -->
    <div id="home" class="page active">
      <h1>产线异常提报</h1>
      <button id="scanBtn" class="btn-primary">扫描工站二维码</button>
      <div id="reader"></div>
    </div>

    <!-- 表单页（初始隐藏） -->
    <div id="form" class="page">
      <h2>异常提报</h2>
      <div class="form-group">
        <label>产品</label>
        <input type="text" id="product" readonly />
      </div>
      <div class="form-group">
        <label>线别</label>
        <input type="text" id="line" readonly />
      </div>
      <div class="form-group">
        <label>工站</label>
        <input type="text" id="station" readonly />
      </div>
      <div class="form-group">
        <label>异常类别</label>
        <div class="radio-group">
          <label><input type="radio" name="category" value="设备类异常" /> 设备类异常</label>
          <label><input type="radio" name="category" value="制程类异常" /> 制程类异常</label>
          <label><input type="radio" name="category" value="安全类异常" /> 安全类异常</label>
          <label><input type="radio" name="category" value="其他" /> 其他</label>
        </div>
      </div>
      <div class="form-group">
        <label>异常说明</label>
        <textarea id="description" placeholder="请描述异常现象…"></textarea>
      </div>
      <button id="submitBtn" class="btn-primary">提交</button>
    </div>

    <!-- 二维码生成页 -->
    <div id="qrcode-gen" class="page">
      <h2>生成工站二维码</h2>
      <div class="form-group">
        <label>产品</label>
        <input type="text" id="genProduct" />
      </div>
      <div class="form-group">
        <label>线别</label>
        <input type="text" id="genLine" />
      </div>
      <div class="form-group">
        <label>工站</label>
        <input type="text" id="genStation" />
      </div>
      <button id="genQrBtn" class="btn-primary">生成二维码</button>
      <div id="qrcodeContainer" style="margin-top: 20px;"></div>
      <button id="downloadBtn" class="btn-secondary" style="display:none;">下载 PNG</button>
    </div>

    <!-- MQTT 配置页 -->
    <div id="mqtt-config" class="page">
      <h2>MQTT 配置</h2>
      <div class="form-group">
        <label>域名</label>
        <input type="text" id="mqttHost" placeholder="如 mqtt.example.com" />
      </div>
      <div class="form-group">
        <label>端口</label>
        <input type="number" id="mqttPort" placeholder="如 8083" />
      </div>
      <div class="form-group">
        <label>用户名</label>
        <input type="text" id="mqttUsername" />
      </div>
      <div class="form-group">
        <label>密码</label>
        <input type="password" id="mqttPassword" />
      </div>
      <div class="form-group">
        <label>Client ID</label>
        <input type="text" id="mqttClientId" />
      </div>
      <div class="form-group">
        <label>上报 Topic</label>
        <input type="text" id="mqttTopic" placeholder="如 factory/exception/report" />
      </div>
      <button id="testMqttBtn" class="btn-primary">联通测试</button>
    </div>
  </div>

  <!-- 底部导航 -->
  <nav class="bottom-nav">
    <a href="#home" class="nav-item active">扫码</a>
    <a href="#qrcode-gen" class="nav-item">生成</a>
    <a href="#mqtt-config" class="nav-item">设置</a>
  </nav>

  <!-- ✅ 本地库（推荐） -->
  <script src="./libs/html5-qrcode.min.js"></script>
  <script src="./libs/qrcode.min.js"></script>
  <script src="./libs/paho-mqtt.min.js"></script>
  <script src="app.js"></script>

  <!-- ✅ 唯一且正确的 Service Worker 注册 -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('✅ Service Worker 注册成功:', reg.scope))
          .catch(err => console.error('❌ Service Worker 注册失败:', err));
      });
    }
  </script>
</body>
</html>